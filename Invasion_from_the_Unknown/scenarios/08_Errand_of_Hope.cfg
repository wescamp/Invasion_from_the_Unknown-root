[scenario]
	#textdomain wesnoth-Invasion_from_the_Unknown
	id=08_Errand_of_Hope
	name= _ "An Errand of Hope"
	{MAP 08_Errand_of_Hope.map}
	{TURNS 76 73 70}
	next_scenario=08x_Interlude
	victory_when_enemies_defeated=no

	{UNDERGROUND}
	{SCENARIO_MUSIC "underground.ogg"}

	{STORYTXT_ERRAND_OF_HOPE}
	{STORYMAP_ERRAND_OF_HOPE}

	{DEATHS_COMMON}

	[side]
		type=Elvish Hero
		description=Galas
		user_description= _ "Galas"
		unrenamable=yes
		side=1
		canrecruit=1
		controller=human
		team_name=good
		shroud=yes
	[/side]

#define KEEP_AWAY_FROM_PRECIPICE
	[avoid]
		x=2
		y=28-29
	[/avoid]
	[avoid]
		x=3
		y=30-32
	[/avoid]
	[avoid]
		x=4
		y=31
	[/avoid]
#enddef

	[side]
		type=Dwarvish Arcanister
		description=Althurin
		user_description= _ "Althurin"
		unrenamable=yes
		side=2
		canrecruit=1
		team_name=good
		[ai]
			caution=0.6
			grouping=defensive
			{KEEP_AWAY_FROM_PRECIPICE}
			village_value=0.1
		[/ai]
		{GOLD 230 190 140}
		{QUANTITY recruit
				(Dwarvish Ulfserker,Dwarvish Pathfinder,Dwarvish Scout,Dwarvish Steelclad,Dwarvish Runesmith,Dwarvish Fighter,Dwarvish Thunderwheel,Dwarvish Steamwheel,Dwarvish Thunderer,Dwarvish Flamethrower,Dwarvish Thundergard)
				(Dwarvish Pathfinder,Dwarvish Scout,Dwarvish Runesmith,Dwarvish Fighter,Dwarvish Thunderwheel,Dwarvish Thunderer,Dwarvish Flamethrower)
				(Dwarvish Scout,Dwarvish Runesmith,Dwarvish Fighter,Dwarvish Thunderwheel,Dwarvish Thunderer)
		}
		{INCOME 4 3 2}
	[/side]

#define DONT_KILL_THE_DWARVEN_LEADER
	# I don't want the enemies to kill the dwarf leader before
	# our heros sight him!
	[avoid]
		x=1-18
	 	y=1-4
	[/avoid]
#enddef

	[side]
		side=3
		description=Hazor
		user_description= _ "Hazor"
		type=Chaos Lore
		canrecruit=1
		unrenamable=yes
		recruit=Demon,Demon Grunt,Demon Zephyr,Chaos Hound,Dark Knight,Chaos Invader,Chaos Invoker,Chaos Headhunter
		{GOLD 200 225 250}
		{CHAOS_FLAG}
		team_name=shadowm_minions
		[ai]
			{KEEP_AWAY_FROM_PRECIPICE}
			{DONT_KILL_THE_DWARVEN_LEADER}
			recruitment_ignore_bad_movement=yes
			recruitment_pattern=scout,scout,fighter,mixed fighter,archer,archer,mixed fighter,fighter,scout
		[/ai]
	[/side]

	[side]
		side=4
		description=Kwurg
		user_description= _ "Kwurg"
		type=Troll Warrior
		canrecruit=1
		unrenamable=yes
		{QUANTITY recruit
			(Troll Whelp,Troll,Troll Shaman)
			(Troll Whelp,Troll,Troll Rocklobber,Troll Shaman)
			(Troll,Troll Rocklobber,Troll Shaman)
		}
		{INCOME 1 2 4}
		{GOLD 200 250 350}
		team_name=trolls
		[ai]
			{KEEP_AWAY_FROM_PRECIPICE}
			{DONT_KILL_THE_DWARVEN_LEADER}
			recruitment_pattern=fighter,mixed fighter,fighter,fighter,mixed fighter,fighter
		[/ai]
	[/side]

	[side]
		side=5
		no_leader=yes
		team_name=nagas
		[ai]
			{KEEP_AWAY_FROM_PRECIPICE}
			{DONT_KILL_THE_DWARVEN_LEADER}
			village_value=0
			agression=0.8
			caution=0
			grouping=no
		[/ai]
	[/side]

	[side]
		side=6
		no_leader=yes
		team_name=cavecreeps
		[ai]
			{KEEP_AWAY_FROM_PRECIPICE}
			{DONT_KILL_THE_DWARVEN_LEADER}
			village_value=0
			agression=0.5
			caution=0
			grouping=no
		[/ai]
	[/side]

#undef KEEP_AWAY_FROM_PRECIPICE
#undef DONT_KILL_THE_DWARVEN_LEADER

	{STARTING_VILLAGES 2 7}
	{STARTING_VILLAGES 3 5}
	{STARTING_VILLAGES 4 5}

	[event]
		name=prestart

		# Make things more interesting having a side-effect of UtBS events
		# in "Subterranean Struggle" somehow - INCOMPLETE, FIXME
		{RANDOM 1..10}
		{VARIABLE quenoth_allied_to_dwarves $random}
		{VARIABLE_OP quenoth_allied_to_dwarves modulo 2}
		# if it's really divisible, $ = 0, so they didn't ally with dwarves
		# otherwise, $ = 1, so they did ally with dwarves
		{CLEAR_VARIABLE random}
		# TODO: remove following line
		{VARIABLE quenoth_allied_to_dwarves 1}
		# TODO: at some point I could have an additional troll branch, but it would require
		# some further thinking I don't desire to do right now. In any case, instead of asking
		# the player, the alliance decission should depend on the variable declared above

		{PLACE_IMAGE scenery/signpost.png 1 3}

		# Recall heroes
		{RECALL_POS Analia 25 42}
		{RECALL_POS (Mal Keshar) 25 43}
		{RECALL_LOYAL_POS melee 27 42}
		{RECALL_LOYAL_POS ranged 27 43}
		{RECALL_LOYAL_POS healer 26 41}

		{VARIABLE met_dwarves 0}
		{VARIABLE met_doom 0}

		[objectives]
			side=1
			{OBJECTIVE_TO_WIN ( _ "Explore the caves and defeat any enemies you find")}
			{OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
			{OBJECTIVE_TO_LOSE ( _ "Death of Analia")}
			{OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
			{OBJECTIVE_TO_LOSE ( _ "Turns run out")}
		[/objectives]
	[/event]

	[event]
		name=start

		{MSG_UNIT Analia ( _ "So, what is the name of this place, Keshar?")}
		{MSG_UNIT (Mal Keshar) ( _ "It used to be called Knalga, the Dwarven Kingdom. I am not sure if there are any dwarves left to justify its name in this era.")}
		{MSG_UNIT Galas ( _ "Dwarves? Like...")}
		{MSG_UNIT Analia ( _ "Like that?")}

		[remove_shroud]
			x=16-23
			y=41-44
		[/remove_shroud]

		{REDRAW}

		[move_unit_fake]
			side=2
			type=Dwarvish Fighter
			x=15,21
			y=43,43
		[/move_unit_fake]
		[unit]
			side=2
			x,y=21,43
			type=Dwarvish Fighter
			description=Dwarf
			user_description= _ "Dwarf"
			hitpoints=4
			upkeep=loyal
			[modifications]
				{TRAIT_RESILIENT}
				{TRAIT_HEALTHY}
			[/modifications]
		[/unit]

		{MSG_UNIT Dwarf ( _ "Help! I need... help! It almost has me!")}

		[move_unit_fake]
			side=4
			type=Troll
			x=15,20
			y=43,43
		[/move_unit_fake]
		[unit]
			side=4
			x,y=20,43
			type=Troll
			description=Troll
			user_description= _ "Troll"
			upkeep=loyal
			[modifications]
				{TRAIT_STRONG}
				{TRAIT_INTELLIGENT}
			[/modifications]
		[/unit]

		{MSG_UNIT Troll ( _ "Roar!!!")}
		# Fake troll melee attack animation
		# It's based on /data/core/units/trollss/Troll.cfg of Wesnoth 1.3.7
		[store_unit]
			[filter]
				description=Troll
			[/filter]
			kill=yes
			variable=troll_probe
		[/store_unit]

		# FAKE ANIMATION START
		{PLACE_IMAGE "units/trolls/grunt.png~RC(magenta>purple)" 20 43}
		{REDRAW}
		{DELAY 25}

		{REMOVE_IMAGE 20 43}
		{PLACE_IMAGE "units/trolls/grunt-attack-1.png~RC(magenta>purple)" 20 43}
		{REDRAW}
		{DELAY 75}

		{REMOVE_IMAGE 20 43}
		{PLACE_IMAGE "units/trolls/grunt-attack-2.png~RC(magenta>purple)" 20 43}
		{PLAY_SOUND "club.ogg"}
		{REDRAW}
		{DELAY 75}

		{REMOVE_IMAGE 20 43}
		{PLACE_IMAGE "units/trolls/grunt-attack-3.png~RC(magenta>purple)" 20 43}
		{REDRAW}
		{DELAY 75}

		{REMOVE_IMAGE 20 43}
		{PLACE_IMAGE "units/trolls/grunt-attack-4.png~RC(magenta>purple)" 20 43}
		{REDRAW}
		{DELAY 95}

		{REMOVE_IMAGE 20 43}
		{PLACE_IMAGE "units/trolls/grunt-attack-3.png~RC(magenta>purple)" 20 43}
		{REDRAW}
		{DELAY 80}

		{REMOVE_IMAGE 20 43}
		{PLACE_IMAGE "units/trolls/grunt-defend.png~RC(magenta>purple)" 20 43}
		{REDRAW}
		{DELAY 75}
		# FAKE ANIMATION END
		{REMOVE_IMAGE 20 43}
		[unstore_unit]
			variable=troll_probe
		[/unstore_unit]
		{CLEAR_VARIABLE troll_probe}
		{REDRAW}
		{MSG_UNIT Dwarf ( _ "Aaaah...")}
		[kill]
			description=Dwarf
			animate=yes
		[/kill]
		{REDRAW}
		{MSG_UNIT (Mal Keshar) ( _ "Exactly... uhm... Alright.")}
		{PLAY_SOUND "magic-dark-big.ogg"}
		{FLASH_RED {VOID} }
		[kill]
			description=Troll
			animate=yes
		[/kill]
		{REDRAW}
		[unit]
			description=Troll's Corpse
			user_description= _ "Troll's Corpse"
			{QUANTITY type (Soulless) (Walking Corpse) (Walking Corpse)}
			x,y=20,43
			side=1
			upkeep=full
			variation=troll
			[modifications]
				{TRAIT_UNDEAD}
			[/modifications]
		[/unit]
		[unit]
			description=Dwarf's Corpse
			user_description= _ "Dwarf's Corpse"
			{QUANTITY type (Soulless) (Walking Corpse) (Walking Corpse)}
			x,y=21,43
			side=1
			upkeep=full
			variation=dwarf
			[modifications]
				{TRAIT_UNDEAD}
				{TRAIT_FEARLESS}
			[/modifications]
		[/unit]
		{MSG_UNIT (Mal Keshar) ( _ "Uh, interesting. Their corpses conserve part of their former strength.")}
		{MSG_UNIT Analia ( _ "...")}
		{MSG_UNIT (Mal Keshar) ( _ "Why are you looking at me in that manner?")}
		{MSG_UNIT Analia ( _ "So, there must be dwarves left, unless we had the luck of witnessing the death... and rising as undead, of the last one.")}
		{MSG_UNIT Galas ( _ "What should we do?")}
		{MSG_UNIT Analia ( _ "Search for their leader and ask for help. We won't survive much time in these caves without help of experts in these... cavey bussiness.")}
		{MSG_UNIT (Mal Keshar) ( _ "Dwarves and elves were never friends in my time.")}
		{MSG_UNIT Analia ( _ "That's true, but they might agree if we offer them something in exchange. Those greedy cave-dwellers would not refuse some gold and help, do you think so Galas?")}
		{MSG_UNIT Galas ( _ "I guess so. But help with what?")}
		{MSG_UNIT Analia ( _ "Their natural enemies: Trolls. We'd better rid these tunnels of them before asking the dwarves anything.")}
		{MSG_UNIT Galas ( _ "Very well.")}
		{MSG_UNIT (Mal Keshar) ( _ "They'll make interesting additions to my collection.")}
	[/event]

	##################### Someone falls down the abyss #####################
	[event]
		name=moveto
		first_time_only=no
		[filter]
			x=2
			y=28-29
		[/filter]

		[if]
			[variable]
				name=met_doom
				numerical_not_equals=1
			[/variable]
			[then]
				[if]
					[have_unit]
						x=$x1
						y=$y1
						[not]
							type=Vampire Bat,Blood Bat,Dread Bat,Ghost,Shadow,Wraith,Nightgaunt,Spectre
						[/not]
						[not]
							description=Mal Keshar
						[/not]
						[not]
							description=Galas
						[/not]
						[not]
							description=Analia
						[/not]
					[/have_unit]
					[then]
						{VARIABLE met_doom 1}
						{TREMOR}
						[terrain]
							x=2
							y=28-29
							letter=Qxu
						[/terrain]
						{REDRAW}
						{MSG_NARRATOR ( _ "The cave's floor falls down, leaving the poor unit with no ground to stand on, thus falling off to the depths of the world. Who knows what fate awaits them at the chasm's bottom.")}
						[message]
							speaker=unit
							message= _ "AAAAAAaaaaaaaaaaaaaaaaaaaahhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh..."
						[/message]
						[kill]
							x,y=$x1,$y1
							animate=yes
							fire_event=no
						[/kill]
					[/then]
					[else]
						[if]
							[have_unit]
								x=$x1
								y=$y1
								[not]
									type=Vampire Bat,Blood Bat,Dread Bat
								[/not]
							[/have_unit]
							[then]
								[message]
									speaker=unit
									message= _ "Uh, the cave's floor here looks particularily weak."
								[/message]
							[/then]
							[else]
								[message]
									speaker=unit
									message= _ "Neep, neep, neeeeep! (translated: 'Cave floor weak, cave floor weak!')"
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/then]
		[/if]
	[/event]

	##################### Party meets the baddies #####################
	[event]
		name=sighted
		[filter]
			side=3
		[/filter]
		[filter_second]
			side=1
		[/filter_second]

		[message]
			speaker=unit
			message= _ "What? It is impossible! The Goliath was supposed to have killed you all! How..."
		[/message]

		[message]
			speaker=second_unit
			message= _ "... could we be so cool to have killed it first?"
		[/message]

		[message]
			speaker=unit
			message= _ "Argh. Impossible..."
		[/message]
		{TREMOR}
		# The Master speaks. Damn, this is thrilling even me, the author :)
		[message]
			speaker=narrator
			caption= _ "Looming Voice coming from Everywhere"
			message= _ "If the Goliath could not with them, then kill them once and for all!"
			image=units/random-enemy.png
		[/message]
		[message]
			speaker=unit
			message= _ "Yes, Master!"
		[/message]
		{TREMOR}
		{PLAY_SOUND dwarf-laugh.wav}
		{MSG_UNIT Hazor ( _ "As you command, my Master.")}
		{MSG_UNIT Analia ( _ "The same tremor and insane laugh we heard when we sighted that infamous 'Goliath'. What could it be?")}
		{MSG_UNIT Galas ( _ "Sounds like their 'Master'. It must be here, somewhere...")}
		{MSG_UNIT (Mal Keshar) ( _ "Only if it can conceal its own presence. I can't detect it, so perhaps it was just an illusion created by it to frighten us.")}
		{MSG_UNIT Galas ( _ "I hope so...")}
		{MSG_UNIT Analia ( _ "This is getting more and more intriguing.")}
	[/event]

	##################### Good elves meet trolls #####################
	[event]
		name=sighted
		[filter]
			side=4
		[/filter]
		[filter_second]
			side=1
			race=elf
		[/filter_second]

		# TODO: good place for the storyline divergence here!
		#[if]
		#	[variable]
		#		name=quenoth_allied_to_dwarves
		#		numerical_equals=0
		#	[/variable]
		#	[then]
		#		[message]
		#			speaker=unit
		#			message= _ "Elves? You allies in the past have been, would you now help us?"
		#		[/message]
		#	[/then]
		#[/if]

		[message]
			speaker=unit
			message= _ "Elves? You treacherous ones, begone, now, or kill you we shall!"
		[/message]

		[message]
			speaker=Galas
			message= _ "Dream about that, beast!"
		[/message]
	[/event]

	##################### Good undead meet trolls #####################
	[event]
		name=sighted
		[filter]
			side=4
		[/filter]
		[filter_second]
			side=1
			race=undead
			[or]
				race=bats
			[/or]
		[/filter_second]

		[message]
			speaker=unit
			message= _ "Undead! Begone creepy one, or crush you we shall!"
		[/message]

		[message]
			speaker=Mal Keshar
			message= _ "Nobody crushes my minions... and lives!"
		[/message]
	[/event]

#define UNDEAD_ENTRY_ALLIED
 _ "Elves too? Fighting together with undead? Odd, but your kinsmen helped us some centuries ago when the trolls invaded our main tunnels. Would you help us now?"#enddef
#define UNDEAD_ENTRY_ENEMIED
_ "Elves too? Fighting together with undead? Not really surprising, as your kinsmen allied with the trolls against us some centuries ago."#enddef
#define ELVES_ENTRY_ALLIED
 _ "Elves? Fighting together with undead? Odd, but your kinsmen helped us some centuries ago when the trolls invaded our main tunnels. Would you help us now?"#enddef
#define ELVES_ENTRY_ENEMIED
_ "Elves? Fighting together with undead? Not really surprising, as your kinsmen allied with the trolls against us some centuries ago."#enddef

#define DWARVES_AND_ELVES_DIALOGUE ENTRY_ALLIED ENTRY_ENEMIED
	[if]
		[variable]
			name=quenoth_allied_to_dwarves
			numerical_equals=1
		[/variable]
		[then]
			[message]
				speaker=unit
				message={ENTRY_ALLIED}
			[/message]
			{MSG_UNIT Galas ( _ "Kinsmen? I don't get it. Our people have never been out of our valley since the Fall!")}
			[message]
				speaker=unit
				message= _ "Valley? What valley? You came from the desert..."
			[/message]
			{MSG_UNIT Analia ( _ "This explains a lot of things actually. We shall help you.")}
			{MSG_UNIT Galas ( _ "Analia?")}
			[message]
				speaker=unit
				message= _ "Very well. If you don't mind, there is a fiendish dark mage and a bunch of annoying trolls causing trouble in these tunnels right now. It should not be too difficult for you to get rid of them. If you succeed, I'll happily lead you to my leader."
			[/message]
			{MSG_UNIT Analia ( _ "We shall do our best.")}
			{MSG_UNIT Galas ( _ "What is going on? Elves from the desert? Analia, might them have...")}
			{MSG_UNIT Analia ( _ "I think that would be chatter for a better moment. We should discuss it later when we have finished our new job here.")}
			{MSG_UNIT Galas ( _ "Alright.")}
		[/then]
		[else]
			[message]
				speaker=unit
				message={ENTRY_ENEMIED}
			[/message]
			{MSG_UNIT Galas ( _ "Kinsmen? I don't get it. Our people have never been out of our valley since the Fall!")}
			[message]
				speaker=unit
				message= _ "Valley?"
			[/message]
			{MSG_UNIT Analia ( _ "I think it'd be better if I spoke instead of you Galas.")}
			{MSG_UNIT Galas ( _ "Alright.")}
			{MSG_UNIT Analia ( _ "Those elves might have been corrupted by the power of what brought you demons to this place. If you let me say so, in past ages we were allies in times of great need and difficulty, and I think this is such a moment.")}
			[message]
				speaker=unit
				message= _ "And how can I trust you? How can I know that you aren't corrupted by the fiends and are not just trying to trick us in order to obtain our riches and territory and take over the underground? You are accompanied by a necromancer, that settles it."
			[/message]
			[store_side]
				side=1
			[/store_side]
			{VARIABLE eoh_adv_gold $side.gold}
			{VARIABLE_OP eoh_adv_gold divide 2}
			{VARIABLE eoh_spent_gold $side.gold}
			{VARIABLE_OP eoh_spent_gold divide 2}
			{CLEAR_VARIABLE side}
			{MSG_UNIT Analia ( _ "Because we would not give away our gold if we were doing so. Do you think $eoh_spent_gold pieces of gold would be enough for you if you led us with your lord to have an in-depth discussion on this matter? We shall give you $eoh_adv_gold in advance if you want.")}
			[message]
				speaker=unit
				message= _ "Um... that's a better deal. Give me $eoh_adv_gold pieces in advance and I shall keep $eoh_spent_gold if you rid these tunnels of that foul dark mage and those annoying trolls."
			[/message]
			{MSG_UNIT Analia ( _ "Very well.")}
			[sound]
				name=gold.ogg
			[/sound]
			
			[message]
				speaker=narrator
				image="items/gold-coins-medium.png"
				message= _ "You give the dwarves $eoh_adv_gold pieces of gold."
			[/message]
			
			[gold]
				side=1
				amount=-$eoh_adv_gold
			[/gold]

			[event]
				name=victory
				[message]
					speaker=narrator
					image="items/gold-coins-medium.png"
					message= _ "The dwarves return $eoh_adv_gold pieces of gold, and you give them $eoh_spent_gold in exchange for the deal."
				[/message]
				[gold]
					side=1
					amount=$eoh_adv_gold
				[/gold]
				[gold]
					side=1
					amount=-$eoh_spent_gold
				[/gold]
				{CLEAR_VARIABLE eoh_adv_gold}
				{CLEAR_VARIABLE eoh_spent_gold}
			[/event]
		[/else]
	[/if]

	[objectives]
		side=1
		summary= _ "New objectives:"
		{OBJECTIVE_TO_WIN ( _ "Defeat the Dark Mage and the invader Trolls")}
		{OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
		{OBJECTIVE_TO_LOSE ( _ "Death of Analia")}
		{OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
		# This should NOT happen, as I told the AI to avoid his keep, but well...
		{OBJECTIVE_TO_LOSE ( _ "Death of Althurin")}
		{OBJECTIVE_TO_LOSE ( _ "Turns run out")}
	[/objectives]
#enddef

	##################### Good undead meet dwarves #####################
	[event]
		name=sighted
		[filter]
			side=2
		[/filter]
		[filter_second]
			side=1
			race=undead
			[or]
				race=bats
			[/or]
		[/filter_second]
		[if]
			[variable]
				name=met_dwarves
				numerical_not_equals=1
			[/variable]
			[then]
				{VARIABLE met_dwarves 1}
				[message]
					speaker=unit
					message= _ "Undead! It's been a long time without these foul walking piles of bones! Let me crush it!"
				[/message]
				[message]
					speaker=Galas
					message= _ " *cough*"
				[/message]
				{DWARVES_AND_ELVES_DIALOGUE {UNDEAD_ENTRY_ALLIED} {UNDEAD_ENTRY_ENEMIED}}
			[/then]
		[/if]
	[/event]

	##################### Good elves meet dwarves #####################
	[event]
		name=sighted
		[filter]
			side=2
		[/filter]
		[filter_second]
			side=1
			race=elf
		[/filter_second]
		[if]
			[variable]
				name=met_dwarves
				numerical_not_equals=1
			[/variable]
			[then]
				{VARIABLE met_dwarves 1}
				{DWARVES_AND_ELVES_DIALOGUE {ELVES_ENTRY_ALLIED} {ELVES_ENTRY_ENEMIED}}
			[/then]
		[/if]
	[/event]

	##################### Good boys meet the Nagas #####################
	# I know this is utterly ridiculous, and doesn't fit to to the Wesnoth's
	# Heroes-Hate-Nagas canon, but I couldn't resist...
	[event]
		name=moveto
		[filter]
			side=1
			x=5 ,6
			y=35,33
		[/filter]

		[message]
			speaker=unit
			message= _ "Wait. I hear something! Who goes there?"
		[/message]

		# Create the Naga gang
		[unit]
			{QUANTITY type (Naga Fighter) (Naga Warrior) (Naga Myrmidon)}
			description=Xargazzi
			user_description= _ "Xargazzi"
			gender=female
			side=5
			x=5
			y=35
			unrenamable=yes
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_INTELLIGENT}
			[/modifications]
		[/unit]
		[unit]
			{QUANTITY type (Naga Fighter) (Naga Fighter) (Naga Warrior)}
			description=Abraxass
			user_description= _ "Abraxass"
			side=5
			x=5
			y=35
			unrenamable=yes
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_STRONG}
			[/modifications]
		[/unit]
		[unit]
			type=Naga Fighter
			description=Argozza
			user_description= _ "Argozza"
			side=5
			x=5
			y=35
			unrenamable=yes
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_RESILIENT}
			[/modifications]
		[/unit]

		[if]
			[have_unit]
				race=undead
				x=$x1
				y=$y1
			[/have_unit]
			[or]
				[have_unit]
					race=bats
					x=$x1
					y=$y1
				[/have_unit]
			[/or]
			[then]
				{MSG_UNIT Xargazzi ( _ "Can't we have some peazzz, what the... undead! We sssshall not tolerate thissss, en garde!")}
				{VARIABLE temp_speaker Galas}
			[/then]
			[else]
				{MSG_UNIT Xargazzi ( _ "Can't we have some peazzz? In the ssssurface there are thossse foul filthy fiendsss, and here underground we have these intrudersss...")}
				{VARIABLE temp_speaker unit}
			[/else]
		[/if]

		{MSG_SPEAKER $temp_speaker ( _ "These are not times of peace. You will never find peace again until the evil is finally vanquished.")}
		{MSG_UNIT Xargazzi ( _ "I sssee.")}
		{MSG_NARRATOR ( _ "You notice you are not speaking to senseless creatures, but to intelligent potential allies. So, you decide to ask them...")}
		{MSG_SPEAKER $temp_speaker ( _ "Would you join us? We might appreciate your help.")}
		{MSG_UNIT Xargazzi ( _ "What for?")}
		{MSG_SPEAKER $temp_speaker ( _ "We want to vanquish the evil to finally have some peace, like you.")}
		{MSG_UNIT Xargazzi ( _ "So we'd get peazzz again? And what elssse? If you don't have a good offer, we ssshall ssstay here, if you don't mind.")}

		[if]
			[variable]
				name=temp_speaker
				not_equals="Galas"
			[/variable]
			[then]
				{MSG_SPEAKER $temp_speaker ( _ "Leader?")}
			[/then]
		[/if]

		[message]
			speaker=Galas
			message= _ "Um..."
			[option]
				message= _ "A better home, in the big water called 'Ocean', far to the west, to be free!"
				[command]
					{VARIABLE temp_speech_got_it 0}
					{MSG_UNIT Xargazzi ( _ "Ssssorry, we sssshall never have peazzz or freedom in the ocean, with the filthy mermen.")}
				[/command]
			[/option]
			[option]
				message= _ "Gold. What about 10 pieces to start with?"
				[command]
					{VARIABLE temp_speech_got_it 0}
					{MSG_UNIT Xargazzi ( _ "We are not interesssted in brilliant metal peezzees. Sssorry.")}
				[/command]
			[/option]
			[option]
				message= _ "Some fun, killing enemies with us, perhaps..."
				[command]
					{VARIABLE temp_speech_got_it 1}
					{MSG_UNIT Xargazzi ( _ "Sssoundss like fun. What do you think, brethen?")}
					{MSG_UNIT Argozza ( _ "Good deal, indeed.")}
					{MSG_UNIT Abraxass ( _ "I agree with that.")}
				[/command]
			[/option]
		[/message]

		[if]
			[variable]
				name=temp_speech_got_it
				numerical_not_equals=1
			[/variable]
			[then]
				{MSG_SPEAKER $temp_speaker ( _ "Alright.")}
				{MSG_UNIT Galas ( _ "What do you think, Analia?")}
				[message]
					speaker=Analia
					message= _ "Um..."
					[option]
						message= _ "I do not trust them. We should kill them just in case they attack us afterwards."
						[command]
							{MSG_UNIT Galas ( _ "Very well. Kill them.")}
							{MSG_UNIT Xargazzi ( _ "Treasssherousss foolsss! You shall die firsssst!!")}
							[event]
								name=die
								[filter]
									description=Xargazzi
								[/filter]
								[message]
									speaker=unit
									message= _ "I hope thisss ssservess as a lesssson to our sspeciesss about the treachery of the ssssurface dwellersss..."
								[/message]
							[/event]
							[event]
								name=die
								[filter]
									description=Abraxass
								[/filter]
								[message]
									speaker=unit
									message= _ "Argh..."
								[/message]
							[/event]
							[event]
								name=die
								[filter]
									description=Argozza
								[/filter]
								[message]
									speaker=unit
									message= _ "Ssstupid creaturesss..."
								[/message]
							[/event]
						[/command]
					[/option]
					[option]
						message= _ "They have chosen their path. We must respect their decission."
						[command]
							{MSG_UNIT Galas ( _ "Very well.")}
							[kill]
								side=5
								animate=no
							[/kill]
						[/command]
					[/option]
				[/message]
			[/then]
			[else]
				{MSG_SPEAKER $temp_speaker ( _ "Great then, welcome to our group!")}
				# They adhere to the player's side!
				{CHANGE_SIDE_SUF (description=Xargazzi) 1}
				{CHANGE_SIDE_SUF (description=Argozza) 1}
				{CHANGE_SIDE_SUF (description=Abraxass) 1}
				{NAGA_DEATHS}

				[modify_side]
					side=5
					team_name=good
				[/modify_side]
			[/else]
		[/if]

		{CLEAR_VARIABLE temp_speech_got_it}
		{CLEAR_VARIABLE temp_speaker}
	[/event]

#define ANT X Y
		[unit]
			x,y={X},{Y}
			type=Giant Ant
			side=6
			upkeep=loyal
		[/unit]
#enddef

	##################### Good boys meet the Ants #####################
	[event]
		name=moveto
		[filter]
			side=1
			x=9-12
			y=37-39
		[/filter]

		{ANT 11 37}
		{ANT 9 38}
		{ANT 11 39}

		[message]
			speaker=unit
			message= _ "Ah! Giant insects!"
		[/message]
		[message]
			speaker=Analia
			message= _ "Ants, but they are bigger than a tiger! What happened to them?"
		[/message]
		[message]
			speaker=Mal Keshar
			message= _ "In the darkness of the depths of the world, most animals and insects grow up over their normal size. So be careful, there might be more dangerous creeps in this place."
		[/message]
	[/event]
	[event]
		name=moveto
		[filter]
			side=1
			x=11-15
			y=11-15
		[/filter]

		# Spawn ants in random locations
		[set_variable]
			name=ant1_x
			random=10..15
		[/set_variable]
		[set_variable]
			name=ant1_y
			random=12..15
		[/set_variable]
		[set_variable]
			name=ant2_x
			random=10..15
		[/set_variable]
		[set_variable]
			name=ant2_y
			random=12..15
		[/set_variable]
		[set_variable]
			name=ant3_x
			random=10..15
		[/set_variable]
		[set_variable]
			name=ant3_y
			random=12..15
		[/set_variable]
		# A 4th ant in HARD difficulty
#ifdef HARD
		[set_variable]
			name=ant4_x
			random=10..15
		[/set_variable]
		[set_variable]
			name=ant4_y
			random=12..15
		[/set_variable]
		{ANT $ant4_x $ant4_y}
#endif
		{ANT $ant1_x $ant1_y}
		{ANT $ant2_x $ant2_y}
		{ANT $ant3_x $ant3_y}
		{CLEAR_VARIABLE ant1_x}
		{CLEAR_VARIABLE ant1_y}
		{CLEAR_VARIABLE ant2_x}
		{CLEAR_VARIABLE ant2_y}
		{CLEAR_VARIABLE ant3_x}
		{CLEAR_VARIABLE ant3_y}
#ifdef HARD
		{CLEAR_VARIABLE ant4_x}
		{CLEAR_VARIABLE ant4_y}
#endif
		[message]
			speaker=unit
			message= _ "It must be common in these caverns to stumble on giant ants such as these..."
		[/message]
	[/event]

#undef ANT

	##################### Enemies defeated / Victory triggerer #####################
	[event]
		name=enemies defeated
		[remove_shroud]
			x=8-18
			y=1-5
		[/remove_shroud]
		[if]
			[variable]
				name=met_dwarves
				numerical_equals=1
			[/variable]
			[then]
				[message]
					speaker=Althurin
					message= _ "Dwarf-friends, you made it. Now, follow me to the Throne Room, King Asthorgar awaits. He'll be pleased to hear... or see news of you."
				[/message]

				{ENDLEVEL_VICTORY yes}
			[/then]
			[else]
				[if]
					[variable]
						name=quenoth_allied_to_dwarves
						numerical_equals=1
					[/variable]
					[then]
						{MSG_UNIT Althurin ( _ "Elves? Fighting together with undead, have just defeated our enemies? Odd, but your kinsmen had already helped us some centuries ago when the trolls invaded our main tunnels.")}
						{MSG_UNIT Galas ( _ "Kinsmen? I don't get it. Our people have never been out of our valley since the Fall!")}
						[message]
							speaker=Althurin
							message= _ "Valley? What valley? You came from the desert..."
						[/message]
						{MSG_UNIT Analia ( _ "This explains a lot of things actually. Could we meet your leader?")}
						{MSG_UNIT Galas ( _ "Analia?")}
						[message]
							speaker=Althurin
							message= _ "Yes, indeed you could. Just follow me to the Throne Room, King Asthorgar awaits."
						[/message]
						{MSG_UNIT Analia ( _ "Very well.")}
						{MSG_UNIT Galas ( _ "What is going on? Elves from the desert? Analia, might them have...")}
						{MSG_UNIT Analia ( _ "I think that would be chatter for a better moment. We should discuss it later, with the dwarven leader.")}
						{MSG_UNIT Galas ( _ "Alright.")}
					[/then]
					[else]
						{MSG_UNIT Althurin ( _ "Elves too? Fighting together with undead? Not really surprising, as your kinsmen allied with the trolls against us some centuries ago. But what really surprises me is that you have defeated the fiendish dark mage and the pesky trolls that were taking over these chambers.")}

						{MSG_UNIT Galas ( _ "Kinsmen? I don't get it. Our people have never been out of our valley since the Fall!")}
						[message]
							speaker=Althurin
							message= _ "Valley?"
						[/message]
						{MSG_UNIT Analia ( _ "I think it'd be better if I spoke instead of you Galas.")}
						{MSG_UNIT Galas ( _ "Alright.")}
						{MSG_UNIT Analia ( _ "Those elves might have been corrupted by the power of what brought you demons to this place. If you let me say so, in past ages we were allies in times of great need and difficulty, and I think this is such a moment.")}
						[message]
							speaker=Althurin
							message= _ "And how can I trust you? How can I know that you aren't corrupted by the fiends and are not just trying to trick us in order to obtain our riches and territory and take over the underground? You are accompanied by a necromancer, that settles it."
						[/message]
						[store_side]
							side=1
						[/store_side]
						{VARIABLE eoh_spent_gold $side.gold}
						{VARIABLE_OP eoh_spent_gold divide 2}
						{CLEAR_VARIABLE side}
						{MSG_UNIT Analia ( _ "Because we would not give away our gold if we were doing so. Do you think $eoh_spent_gold pieces of gold would be enough for you if you led us with your lord to have an in-depth discussion on this matter?")}
						[message]
							speaker=Althurin
							message= _ "Um... that's a good deal. Agreed, but only because you have already done us some good."
						[/message]
						{MSG_UNIT Analia ( _ "Very well.")}
						[sound]
							name=gold.ogg
						[/sound]
						
						[message]
							speaker=narrator
							image="items/gold-coins-medium.png"
							message= _ "You give the dwarves $eoh_spent_gold pieces of gold."
						[/message]
						
						[gold]
							side=1
							amount=-$eoh_spent_gold
						[/gold]
						{CLEAR_VARIABLE eoh_spent_gold}
					[/else]
				[/if]
				{ENDLEVEL_VICTORY yes}
			[/else]
		[/if]
	[/event]

	##################### Victory; just a temporary variables clean-up routine #####################
	[event]
		name=victory
		{CLEAR_VARIABLE met_dwarves}
		{CLEAR_VARIABLE met_doom}
	[/event]

	##################### Good boys meet the Water serpents #####################
	[event]
		name=moveto
		[filter]
			side=1
			x=28
			y=16-18
		[/filter]

		{LOYAL_UNIT 5 (Water Serpent) 28 15 () ()}
		{LOYAL_UNIT 5 (Water Serpent) 27 17 () ()}
		{LOYAL_UNIT 5 (Water Serpent) 27 16 () ()}

		[if]
			[have_unit]
				x=$x1
				y=$y1
				race=elf
			[/have_unit]
			[then]
				[message]
					speaker=unit
					message= _ "Aaah! Scary!"
				[/message]
			[/then]
		[/if]

		[if]
			[have_unit]
				side=1
				race=naga
			[/have_unit]
			[then]
				[message]
					race=naga
					message= _ "Don't frighten, they are our friendsss, they ssshall not hurt you."
				[/message]
				[if]
					[have_unit]
						x=$x1
						y=$y1
						[not]
							race=naga
						[/not]
					[/have_unit]
					[then]
						[message]
							speaker=unit
							message= _ "Who are you speaking with?"
						[/message]
						[message]
							race=naga
							message= _ "With the ssserpentss. They are our friendsss."
						[/message]
						[message]
							speaker=unit
							message= _ "Oh."
						[/message]
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]

	##################### Touch-plate at 15,8 that opens an adjacent chamber #####################
	# Touchplate 15,8
	{ITEM_TOUCHPLATE 15 8}
	{OBJ_POISONOUS_ARROWS 12 9 eoh_poisonbow}
	[event]
		name=moveto
		[filter]
			side=1
			x,y=15,8
		[/filter]

		[removeitem]
			x,y=15,8
		[/removeitem]

		[terrain]
			x,y=14,8
			letter=Ryd
		[/terrain]

		{MSG_NARRATOR (_"Touchplate triggered. A wall moves.")}
	[/event]

	##################### Chest of gold at 20,36 #####################
	[item]
		x,y=20,36
		image=items/chest-plain-closed.png
	[/item]

	[event]
		name=moveto
		[filter]
			x,y=20,36
			side=1
		[/filter]
		[sound]
			name=open-chest.wav
		[/sound]
		[removeitem]
			x,y=20,36
		[/removeitem]
		[item]
			x,y=20,36
			image=items/chest-plain-open.png
		[/item]
		{REDRAW}
		[message]
			speaker=unit
			message= _ "Oh my, who could have left behind such a precious amount of gold! 370 pieces... not bad, huh?"
		[/message]
		{RETRIEVE_GOLD 370}
	[/event]
[/scenario]
